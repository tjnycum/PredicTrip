# Copyright Â© 2020 Terry Nycum. All rights reserved except those granted in a LICENSE file.

# Converters describe the format of data in files to be ingested by GeoMesa

# Using hash of entire input record for id-field ensures the feature ID doesn't vary if the same data is ingested
# multiple times

geomesa.converters.nyc-tlc_tripdata_A : {
    fields : [
//        {
//            name : "Vendor_name",
//            transform : "emptyToNull($1)::string"
//        },
        {
            name : "Pickup_datetime",
            transform : "require(date('yyyy-MM-dd HH:mm:ss',emptyToNull($2)))"
        },
        {
            name : "Dropoff_datetime",
            transform : "date('yyyy-MM-dd HH:mm:ss',emptyToNull($3))"
        },
        {
            name : "Passenger_count",
            transform : "emptyToNull($4)::int"
        },
        {
            name : "Trip_distance",
            transform : "emptyToNull($5)::float"
        },
        {
            name : "Pickup_longitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$6)))::double"
        },
        {
            name : "Pickup_latitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$7)))::double"
        },
//        {
//            name : "RateCodeID",
//            transform : "emptyToNull($8)::int"
//        },
//        {
//            name : "Store_and_fwd_flag",
//            transform : "emptyToNull($9)::boolean"
//        },
        {
            name : "Dropoff_longitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$10)))::double"
        },
        {
            name : "Dropoff_latitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$11)))::double"
        },
//        {
//            name : "Payment_type",
//            transform : "emptyToNull($12)::string"
//        },
//        {
//            name : "Fare_amount",
//            transform : "emptyToNull($13)::float"
//        },
//        {
//            name : "Surcharge",
//            transform : "emptyToNull($14)::float"
//        },
//        {
//            name : "MTA_tax",
//            transform : "emptyToNull($15)::float"
//        },
//        {
//            name : "Tip_amount",
//            transform : "emptyToNull($16)::float"
//        },
//        {
//            name : "Tolls_amount",
//            transform : "emptyToNull($17)::float"
//        },
//        {
//            name : "Total_amount",
//            transform : "emptyToNull($18)::float"
//        },
        {
            name : "Pickup_location",
            transform : "point($Pickup_longitude,$Pickup_latitude)"
        },
        {
            name : "Dropoff_location",
            transform : "point($Dropoff_longitude,$Dropoff_latitude)"
        }
    ],
    type : "delimited-text",
    format : "CSV",
    id-field : "md5(string2bytes($0))",
    options : {
        skip-lines : 1, # header
        encoding : "UTF-8",
        error-mode : "skip-bad-records", # raise-errors
        parse-mode : "incremental",
        validators : [
            "index"
        ]
    }
}

geomesa.converters.nyc-tlc_tripdata_B : {
    fields : [
//        {
//            name : "VendorID",
//            transform : "emptyToNull($1)::int"
//        },
        {
            name : "Pickup_datetime",
            transform : "require(date('yyyy-MM-dd HH:mm:ss',emptyToNull($2)))"
        },
        {
            name : "Dropoff_datetime",
            transform : "date('yyyy-MM-dd HH:mm:ss',emptyToNull($3))"
        },
//        {
//            name : "Store_and_fwd_flag",
//            transform : "emptyToNull($4)::boolean"
//        },
//        {
//            name : "RateCodeID",
//            transform : "emptyToNull($5)::int"
//        },
        {
            name : "Pickup_longitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$6)))::double"
        },
        {
            name : "Pickup_latitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$7)))::double"
        },
        {
            name : "Dropoff_longitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$8)))::double"
        },
        {
            name : "Dropoff_latitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$9)))::double"
        },
        {
            name : "Passenger_count",
            transform : "emptyToNull($10)::int"
        },
        {
            name : "Trip_distance",
            transform : "emptyToNull($11)::float"
        },
//        {
//            name : "Fare_amount",
//            transform : "emptyToNull($12)::float"
//        },
//        {
//            name : "Extra_amount",
//            transform : "emptyToNull($13)::float"
//        },
//        {
//            name : "MTA_tax",
//            transform : "emptyToNull($14)::float"
//        },
//        {
//            name : "Tip_amount",
//            transform : "emptyToNull($15)::float"
//        },
//        {
//            name : "Tolls_amount",
//            transform : "emptyToNull($16)::float"
//        },
//        {
//            name : "EHail_fee",
//            transform : "emptyToNull($17)::float"
//        },
//        {
//            name : "Total_amount",
//            transform : "emptyToNull($18)::float"
//        },
//        {
//            name : "Payment_type",
//            transform : "emptyToNull($19)::string"
//        },
//        {
//            name : "Trip_type",
//            transform : "emptyToNull($20)::int"
//        },
        {
            name : "Pickup_location",
            transform : "point($Pickup_longitude,$Pickup_latitude)"
        },
        {
            name : "Dropoff_location",
            transform : "point($Dropoff_longitude,$Dropoff_latitude)"
        }
    ],
    type : "delimited-text",
    format : "CSV",
    id-field : "md5(string2bytes($0))",
    options : {
        skip-lines : 1, # header
        encoding : "UTF-8",
        error-mode : "skip-bad-records", # raise-errors
        parse-mode : "incremental",
        validators : [
            "index"
        ]
    }
}

geomesa.converters.nyc-tlc_tripdata_C : {
    fields : [
//        {
//            name : "VendorID",
//            transform : "emptyToNull($1)::int"
//        },
        {
            name : "Pickup_datetime",
            transform : "require(date('yyyy-MM-dd HH:mm:ss',emptyToNull($2)))"
        },
        {
            name : "Dropoff_datetime",
            transform : "date('yyyy-MM-dd HH:mm:ss',emptyToNull($3))"
        },
//        {
//            name : "Store_and_fwd_flag",
//            transform : "emptyToNull($4)::boolean"
//        },
//        {
//            name : "RateCodeID",
//            transform : "emptyToNull($5)::int"
//        },
        {
            name : "Pickup_longitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$6)))::double"
        },
        {
            name : "Pickup_latitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$7)))::double"
        },
        {
            name : "Dropoff_longitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$8)))::double"
        },
        {
            name : "Dropoff_latitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$9)))::double"
        },
        {
            name : "Passenger_count",
            transform : "emptyToNull($10)::int"
        },
        {
            name : "Trip_distance",
            transform : "emptyToNull($11)::float"
        },
//        {
//            name : "Fare_amount",
//            transform : "emptyToNull($12)::float"
//        },
//        {
//            name : "Extra_amount",
//            transform : "emptyToNull($13)::float"
//        },
//        {
//            name : "MTA_tax",
//            transform : "emptyToNull($14)::float"
//        },
//        {
//            name : "Tip_amount",
//            transform : "emptyToNull($15)::float"
//        },
//        {
//            name : "Tolls_amount",
//            transform : "emptyToNull($16)::float"
//        },
//        {
//            name : "EHail_fee",
//            transform : "emptyToNull($17)::float"
//        },
//        {
//            name : "Improvement_surcharge",
//            transform : "emptyToNull($18)::float"
//        },
//        {
//            name : "Total_amount",
//            transform : "emptyToNull($19)::float"
//        },
//        {
//            name : "Payment_type",
//            transform : "emptyToNull($20)::string"
//        },
//        {
//            name : "Trip_type",
//            transform : "emptyToNull($21)::int"
//        },
        {
            name : "Pickup_location",
            transform : "point($Pickup_longitude,$Pickup_latitude)"
        },
        {
            name : "Dropoff_location",
            transform : "point($Dropoff_longitude,$Dropoff_latitude)"
        }
    ],
    type : "delimited-text",
    format : "CSV",
    id-field : "md5(string2bytes($0))",
    options : {
        skip-lines : 1, # header
        encoding : "UTF-8",
        error-mode : "skip-bad-records", # raise-errors
        parse-mode : "incremental",
        validators : [
            "index"
        ]
    }
}

geomesa.converters.nyc-tlc_tripdata_D : {
    fields : [
//        {
//            name : "Vendor_name",
//            transform : "emptyToNull($1)::string"
//        },
        {
            name : "Pickup_datetime",
            transform : "require(date('yyyy-MM-dd HH:mm:ss',emptyToNull($2)))"
        },
        {
            name : "Dropoff_datetime",
            transform : "date('yyyy-MM-dd HH:mm:ss',emptyToNull($3))"
        },
        {
            name : "Passenger_count",
            transform : "emptyToNull($4)::int"
        },
        {
            name : "Trip_distance",
            transform : "emptyToNull($5)::float"
        },
        {
            name : "Pickup_longitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$6)))::double"
        },
        {
            name : "Pickup_latitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$7)))::double"
        },
//        {
//            name : "RateCodeID",
//            transform : "emptyToNull($8)::int"
//        },
//        {
//            name : "Store_and_fwd_flag",
//            transform : "emptyToNull($9)::boolean"
//        },
        {
            name : "Dropoff_longitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$10)))::double"
        },
        {
            name : "Dropoff_latitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$11)))::double"
        },
//        {
//            name : "Payment_type",
//            transform : "emptyToNull($12)::string"
//        },
//        {
//            name : "Fare_amount",
//            transform : "emptyToNull($13)::float"
//        },
//        {
//            name : "Extra_amount",
//            transform : "emptyToNull($14)::float"
//        },
//        {
//            name : "MTA_tax",
//            transform : "emptyToNull($15)::float"
//        },
//        {
//            name : "Tip_amount",
//            transform : "emptyToNull($16)::float"
//        },
//        {
//            name : "Tolls_amount",
//            transform : "emptyToNull($17)::float"
//        },
//        {
//            name : "Improvement_surcharge",
//            transform : "emptyToNull($18)::float"
//        },
//        {
//            name : "Total_amount",
//            transform : "emptyToNull($19)::float"
//        },
        {
            name : "Pickup_location",
            transform : "point($Pickup_longitude,$Pickup_latitude)"
        },
        {
            name : "Dropoff_location",
            transform : "point($Dropoff_longitude,$Dropoff_latitude)"
        }
    ],
    type : "delimited-text",
    format : "CSV",
    id-field : "md5(string2bytes($0))",
    options : {
        skip-lines : 1, # header
        encoding : "UTF-8",
        error-mode : "skip-bad-records", # raise-errors
        parse-mode : "incremental",
        validators : [
            "index"
        ]
    }
}

geomesa.converters.nyc-tlc_tripdata_E : {
    fields : [
//        {
//            name : "Vendor_name",
//            transform : "emptyToNull($1)::string"
//        },
        {
            name : "Pickup_datetime",
            transform : "require(date('yyyy-MM-dd HH:mm:ss',emptyToNull($2)))"
        },
        {
            name : "Dropoff_datetime",
            transform : "date('yyyy-MM-dd HH:mm:ss',emptyToNull($3))"
        },
        {
            name : "Passenger_count",
            transform : "emptyToNull($4)::int"
        },
        {
            name : "Trip_distance",
            transform : "emptyToNull($5)::float"
        },
        {
            name : "Pickup_longitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$6)))::double"
        },
        {
            name : "Pickup_latitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$7)))::double"
        },
//        {
//            name : "RateCodeID",
//            transform : "emptyToNull($8)::int"
//        },
//        {
//            name : "Store_and_fwd_flag",
//            transform : "emptyToNull($9)::boolean"
//        },
        {
            name : "Dropoff_longitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$10)))::double"
        },
        {
            name : "Dropoff_latitude",
            transform : "require(emptyToNull(regexReplace('^0$'::r,'',$11)))::double"
        },
//        {
//            name : "Payment_type",
//            transform : "emptyToNull($12)::string"
//        },
//        {
//            name : "Fare_amount",
//            transform : "emptyToNull($13)::float"
//        },
//        {
//            name : "Extra",
//            transform : "emptyToNull($14)::float"
//        },
//        {
//            name : "MTA_tax",
//            transform : "emptyToNull($15)::float"
//        },
//        {
//            name : "Tip_amount",
//            transform : "emptyToNull($16)::float"
//        },
//        {
//            name : "Tolls_amount",
//            transform : "emptyToNull($17)::float"
//        },
//        {
//            name : "Improvement_surcharge",
//            transform : "emptyToNull($18)::float"
//        },
//        {
//            name : "Total_amount",
//            transform : "emptyToNull($19)::float"
//        },
        {
            name : "Pickup_location",
            transform : "point($Pickup_longitude,$Pickup_latitude)"
        },
        {
            name : "Dropoff_location",
            transform : "point($Dropoff_longitude,$Dropoff_latitude)"
        }
    ],
    type : "delimited-text",
    format : "CSV",
    id-field : "md5(string2bytes($0))",
    options : {
        skip-lines : 1, # header
        encoding : "UTF-8",
        error-mode : "skip-bad-records", # raise-errors
        parse-mode : "incremental",
        validators : [
            "index"
        ]
    }
}

# SimpleFeatureType's (SFTs) are like table schemas, describing the desired storage in GeoMesa data stores

geomesa.sfts.trips : {
    attributes : [
        {
            name    : "Pickup_location",
            type    : "Point",
            default : true
        },
        {
            name : "Pickup_datetime",
            type : "Timestamp"
        },
//        {
//            name : "Pickup_dayofweek",
//            type : "Integer"
//        },
//        {
//            name : "Pickup_hourofday",
//            type : "Integer"
//        },
        {
            name : "Dropoff_datetime",
            type : "Timestamp"
        },
        {
            name : "Dropoff_location",
            type : "Point"
        },
        {
            name : "Passenger_count",
            type : "Integer"
        },
        {
            name : "Trip_distance",
            type : "Float"
        }
    ],
    type-name : "trips",
    user-data : {
        geomesa.index.dtg       : "Pickup_datetime"
        geomesa.indices.enabled : "z3"
    }
}
